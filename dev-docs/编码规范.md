# 编码规范文档

## 一、问题背景

在开发过程中，遇到菜单和数据库中文内容乱码的问题。经过分析，主要原因是：
1. 数据库连接时没有显式设置字符集
2. 从文件注释中提取的中文可能编码不对
3. ORM框架在插入数据时可能编码转换不完整

## 二、乱码产生的原因

### 1. 数据库连接编码问题
- **问题**：虽然数据库表设置了 `utf8mb4` 字符集，但连接时没有显式设置 `SET NAMES utf8mb4`
- **影响**：可能导致插入的中文数据编码不正确

### 2. 文件编码问题
- **问题**：PHP文件可能不是UTF-8编码（虽然内容看起来是中文）
- **影响**：从注释中提取的中文可能编码不对

### 3. ORM框架编码转换问题
- **问题**：ThinkPHP的ORM在插入数据时可能编码转换不完整
- **影响**：即使文件是UTF-8，插入数据库时也可能变成乱码

## 三、解决方案

### 1. 数据库连接时显式设置字符集

**在需要操作数据库的命令或控制器中，开始时执行：**

```php
// 确保数据库连接使用UTF-8编码
Db::execute("SET NAMES utf8mb4");
```

**示例：Menu命令**

```php
protected function execute(Input $input, Output $output)
{
    // 确保数据库连接使用UTF-8编码
    Db::execute("SET NAMES utf8mb4");
    
    // ... 其他代码
}
```

### 2. 添加编码检测和转换方法

**创建 `ensureUtf8` 方法，确保所有字符串都是UTF-8编码：**

```php
/**
 * 确保字符串是UTF-8编码
 * 
 * @param string $str
 * @return string
 */
protected function ensureUtf8($str)
{
    if (empty($str)) {
        return $str;
    }
    
    // 如果已经是UTF-8，直接返回
    if (mb_check_encoding($str, 'UTF-8')) {
        return $str;
    }
    
    // 检测编码并转换
    $detected = mb_detect_encoding($str, ['UTF-8', 'GBK', 'GB2312', 'ISO-8859-1'], true);
    if ($detected && $detected !== 'UTF-8') {
        $str = mb_convert_encoding($str, 'UTF-8', $detected);
    } else {
        // 如果检测失败，尝试强制转换
        $str = mb_convert_encoding($str, 'UTF-8', 'auto');
    }
    
    return $str;
}
```

### 3. 在插入数据库前确保编码正确

**所有需要插入数据库的中文字符串，都要先通过 `ensureUtf8` 处理：**

```php
$title = $this->ensureUtf8($title);
$remark = $this->ensureUtf8($remark);

// 然后再插入数据库
$this->model->data([
    'title' => $title,
    'remark' => $remark,
    // ...
])->save();
```

### 4. 文件编码要求

**所有PHP文件必须保存为UTF-8编码（无BOM）：**

- ✅ 使用UTF-8编码
- ❌ 不要使用GBK、GB2312等编码
- ❌ 不要使用UTF-8 with BOM

**检查文件编码的方法：**

```bash
# 检查文件编码
file -I filename.php

# 或者使用hexdump查看文件头
head -1 filename.php | hexdump -C
```

## 四、编码规范检查清单

### 开发前检查
- [ ] 确认IDE/编辑器设置为UTF-8编码
- [ ] 确认文件保存为UTF-8（无BOM）

### 开发时检查
- [ ] 数据库操作前执行 `SET NAMES utf8mb4`
- [ ] 所有中文字符串通过 `ensureUtf8` 处理
- [ ] 从文件注释提取中文时检测编码

### 开发后检查
- [ ] 测试中文内容是否正确显示
- [ ] 检查数据库中的中文数据是否正确
- [ ] 验证后台菜单和内容是否正常

## 五、常见问题处理

### 问题1：菜单显示乱码
**解决方法：**
1. 删除旧菜单数据
2. 确保Menu命令开始时执行 `SET NAMES utf8mb4`
3. 确保控制器注释是UTF-8编码
4. 重新生成菜单

### 问题2：数据库中文内容乱码
**解决方法：**
1. 检查数据库表字符集是否为 `utf8mb4`
2. 检查数据库连接是否设置了 `SET NAMES utf8mb4`
3. 确保插入前字符串是UTF-8编码
4. 删除乱码数据，重新插入

### 问题3：从注释提取的中文乱码
**解决方法：**
1. 确保PHP文件是UTF-8编码
2. 提取后使用 `ensureUtf8` 方法处理
3. 检测并转换编码

## 六、最佳实践

1. **统一使用UTF-8编码**
   - 所有PHP文件使用UTF-8编码
   - 数据库使用utf8mb4字符集
   - 前端页面使用UTF-8编码

2. **显式设置字符集**
   - 数据库连接时显式设置 `SET NAMES utf8mb4`
   - 不要依赖默认设置

3. **编码检测和转换**
   - 从外部数据源获取数据时，检测并转换编码
   - 插入数据库前，确保所有字符串是UTF-8编码

4. **测试验证**
   - 开发完成后，测试所有中文内容是否正确显示
   - 检查数据库中的中文数据是否正确存储

## 七、相关配置

### 数据库配置（database.php）
```php
return [
    // 数据库编码默认采用 utf8mb4
    'charset' => Env::get('database.charset', 'utf8mb4'),
    // ...
];
```

### MySQL表字符集
```sql
CREATE TABLE `fa_table` (
    ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;
```

## 八、总结

遵循以上编码规范，可以有效避免中文乱码问题：
1. ✅ 数据库连接时显式设置字符集
2. ✅ 使用 `ensureUtf8` 方法确保编码正确
3. ✅ 所有文件使用UTF-8编码
4. ✅ 插入数据库前检测和转换编码

**记住：预防胜于治疗，在开发时就遵循规范，避免后续修复乱码的麻烦！**

